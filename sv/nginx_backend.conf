user  root root;
worker_processes  1;
events {
    worker_connections  1024;
}

#error_log logs/error.log info; 

http {
         include       mime.types;
         default_type  application/octet-stream;
         sendfile        on;
         client_max_body_size 500M;
         keepalive_timeout  60s;
         autoindex_localtime on;
         #server_tokens off;
	 #more_set_headers 'Server: Leap';
	 charset UTF-8;
         source_charset UTF-8;
	
         # Expires map
         map $sent_http_content_type $expires {
	         default                    off;
	         text/html                  epoch;
	         text/css                   max;
	         application/javascript     max;
	         ~image/                    max;
        }
	
        map $http_upgrade $connection_upgrade {
                 default upgrade;
                 ''      close;
        }
	
	#for rate limiting DDOS 
	limit_req_zone $binary_remote_addr zone=one:10m rate=1000r/s;
	
	#nginx for DAST of Leap 2.1
	server {
                listen       8082;
		client_max_body_size 500M;
                server_name  "";
		
		
		server_tokens off;
		
		
		proxy_pass_header Server;
		
		override_charset on;
                expires $expires; #this commented in old one
		
		add_header Access-Control-Allow-Methods "GET, PUT, POST";
		
		
		# below impacts performance , so better give 3600 instead of 0
		keepalive_timeout  0;
		proxy_connect_timeout 300;
		proxy_read_timeout 300;
		proxy_send_timeout 300;
                #ssl_certificate         /app/cer/ssl/victadpst-10.cer;
                #ssl_certificate_key     /app/cer/ssl/victadpst-10.key;
                #ssl_protocols           TLSv1.2;
                #proxy_cookie_path / "/; SameSite=None; HTTPOnly; Secure";#this is commented in old one
		proxy_hide_header X-Upstream;
		proxy_hide_header Content-Type; 
		add_header X-Content-Type-Options "nosniff" always;
		add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
		add_header X-Frame-Options "SAMEORIGIN";
		
		
		
		ssl_ciphers ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:!aNULL:!eNULL:!EXPORT:!DES:!MD5:!PSK:!RC4;

		
                ssl_prefer_server_ciphers on;
		charset UTF-8;
		source_charset UTF-8;
                #index  index.html index.htm;
		
		
		location /ws {
                         proxy_pass http://localhost:8081;
                         proxy_http_version 1.1;
                         proxy_set_header Upgrade $http_upgrade;
                         proxy_set_header Connection $connection_upgrade;
                         proxy_set_header Host $host;
                }
		#To handle Account Keycloak url
		location ~* /auth/realms/accountName/account/ {
            		return 403;
		}		
		location /api/ {
	
			limit_except GET PUT POST DELETE { deny all; }
			
			#if ($request_method ~ ^(OPTIONS)$) {
			#	return 403;
			#}
			
			#if ($http_host !~* '^victsecst-25:2100'){
			#	return 403;
			#}
			
			#if ($http_referer !~* '^https://victsecst-25:2100'){
			#	return 403;
			#}
			
			#set $origvicet 0;
			#if ($http_origin !~* '^$|^https://victsecst-25:2100$') {
			#	set $origvicet 1;
			#}
			
			#if ($origvicet ~* 1) {
			#	return 403;
			#}
			
			proxy_pass http://localhost:8081;
			proxy_set_header X-Forwarded-Proto $scheme;
                        proxy_set_header X-Real-IP $remote_addr;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			server_tokens off;
			#override_charset on;
			#charset UTF-8;
			#source_charset UTF-8;
			
			
			add_header 'Content-Type' 'application/json; charset=UTF-8';
			add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
			proxy_hide_header X-Upstream;
			add_header X-XSS-Protection "1; mode=block";
			add_header Content-Security-Policy "default-src 'self'  ;frame-ancestors 'self';object-src 'none';img-src 'self' https: data: ;script-src 'self'   'sha256-zrOm4k/MBtI1YSAgBJs42TvOkvF144vYFt+falqeK9I=' 'sha256-fJiYzT9+ccAlR+q4HdwN2PG0U3MoOJOcB5c09eJPDyI=';style-src-elem 'self' https://use.fontawesome.com https://cdnjs.cloudflare.com https://fonts.googleapis.com; font-src 'self' https: data: https://fonts.gstatic.com https://use.fontawesome.com https://cdnjs.cloudflare.com;" always;	
			add_header X-Frame-Options "SAMEORIGIN";
			add_header Cache-Control "no-cache no-store private";
			add_header Access-Control-Allow-Methods "GET, PUT, POST";
			add_header Access-Control-Allow-Headers "X-Custom-Software, X-My-Custom";
			#proxy_cookie_path / "/; SameSite=None; HTTPOnly; Secure";
			proxy_hide_header X-Upstream;
			proxy_hide_header Content-Type;
                }
		
		location / {
                        proxy_pass http://localhost:8081;
            
                        proxy_set_header X-Forwarded-Proto $scheme;
                        proxy_set_header X-Real-IP $remote_addr;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			limit_except GET PUT POST DELETE { deny all; }
			override_charset on;
			server_tokens off;
			charset UTF-8;
			source_charset UTF-8;
			
			
			add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
			proxy_hide_header Cache-Control;
			add_header Cache-Control "no-cache no-store private";
			add_header Access-Control-Allow-Methods "GET, PUT, POST";
			proxy_hide_header Access-Control-Allow-Headers;
			add_header Access-Control-Allow-Headers "X-Custom-Software, X-My-Custom";
			proxy_cookie_path / "/; SameSite=None; HTTPOnly; Secure";
			proxy_hide_header X-Upstream;
			
			
			expires $expires;
			
			proxy_hide_header X-Frame-Options;
			add_header X-Frame-Options deny;
			
			add_header Access-Control-Allow-Headers "X-Custom-Software, X-My-Custom";
			keepalive_timeout  3600;
			proxy_connect_timeout 300;
			proxy_read_timeout 300;
			proxy_send_timeout 300;
                }
		location /camunda/ {
			proxy_pass http://localhost:8081/camunda/;
			proxy_set_header Host $host:$server_port;
			proxy_set_header X-Forwarded-Proto $scheme;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			add_header X-Frame-Options "SAMEORIGIN";
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "upgrade";
			autoindex on;
			autoindex_exact_size on;
		}
		
		#location /icapapp/ {
		#	proxy_pass http://victadpst-21:8041/;
		#	proxy_set_header Host $host;
		#	proxy_set_header X-Real-IP $remote_addr;
		#	proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		#	proxy_set_header X-Forwarded-Proto $scheme;
		#}
		
                error_page  500 502 503 504 404 /50x.html;

                location = /50x.html {
                        root   html;
                }
		
		error_page  404 /404x.html;

                location = /404x.html {
                        root   /ng/html;
                }
		
		error_page  403 /403x.html;

                location = /403x.html {
                        root   /ng/html;
                }
		location /error {
			root   /ng/html;
		}
    }	
}
